import { useEffect, useState } from 'react'
import './App.css'

import { Line } from 'react-chartjs-2'
import {
  Chart as ChartJS,
  LineElement,
  CategoryScale,
  LinearScale,
  PointElement,
  Tooltip,
  Legend
} from 'chart.js'

ChartJS.register(LineElement, CategoryScale, LinearScale, PointElement, Tooltip, Legend)

function App() {
  const [rows, setRows] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState('')

  useEffect(() => {
    async function load() {
      try {
        const res = await fetch('http://127.0.0.1:8080/api/metrics')
        if (!res.ok) throw new Error('HTTP ' + res.status)
        const data = await res.json()
        setRows(data)
      } catch (err) {
        console.error(err)
        setError(err.message)
      } finally {
        setLoading(false)
      }
    }

    load()
  }, [])

  if (loading) {
    return <p style={{ padding: 40, textAlign: 'center' }}>Loading metricsâ€¦</p>
  }

  if (error) {
    return (
      <p style={{ padding: 40, textAlign: 'center', color: '#c00' }}>
        Error loading metrics: {error}
      </p>
    )
  }

  if (!rows.length) {
    return (
      <p style={{ padding: 40, textAlign: 'center' }}>
        No telemetry rows yet. Run your Î”72 scripts to generate some data.
      </p>
    )
  }

  const headers = Object.keys(rows[0])

  // ðŸ‘‰ tweak these to match your CSV column names
  const labelField = 'timestamp'   // or 'run', 'date', etc.
  const valueField = 'eff'         // or 'savings', 'uplift', etc.

  const labels = rows.map((row, idx) => row[labelField] || `Run ${idx + 1}`)

  const values = rows.map((row) => {
    const v = parseFloat(row[valueField])
    return isNaN(v) ? null : v
  })

  const chartData = {
    labels,
    datasets: [
      {
        label: `Î”72 ${valueField} metric`,
        data: values,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.25,
        pointRadius: 3
      }
    ]
  }

  const chartOptions = {
    responsive: true,
    plugins: {
      legend: {
        labels: { color: '#f5f5f5' }
      },
      tooltip: {
        mode: 'index',
        intersect: false
      }
    },
    scales: {
      x: {
        ticks: { color: '#bbbbbb' },
        grid: { color: '#222' }
      },
      y: {
        ticks: { color: '#bbbbbb' },
        grid: { color: '#222' }
      }
    }
  }

  return (
    <div
      style={{
        fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
        padding: '32px',
        backgroundColor: '#0b0c10',
        minHeight: '100vh',
        color: '#f5f5f5'
      }}
    >
      <h1 style={{ textAlign: 'center', marginBottom: '8px' }}>
        Î”72 Coherence Engine Dashboard
      </h1>
      <p
        style={{
          textAlign: 'center',
          marginBottom: '24px',
          opacity: 0.8,
          fontSize: '0.95rem'
        }}
      >
        Live savings & coherence metrics from your local node.
      </p>

      {/* Chart card */}
      <div
        style={{
          background: '#14161c',
          borderRadius: '12px',
          padding: '16px',
          marginBottom: '24px'
        }}
      >
        <h2 style={{ marginBottom: '12px' }}>Savings / Efficiency Trend</h2>
        <Line data={chartData} options={chartOptions} />
      </div>

      {/* Raw table card */}
      <div
        style={{
          background: '#14161c',
          borderRadius: '12px',
          padding: '16px',
          overflowX: 'auto'
        }}
      >
        <h2 style={{ marginBottom: '12px' }}>Raw Telemetry</h2>
        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
          <thead>
            <tr>
              {headers.map((h) => (
                <th
                  key={h}
                  style={{
                    textAlign: 'left',
                    borderBottom: '1px solid #333',
                    padding: '8px',
                    fontSize: '0.8rem',
                    textTransform: 'uppercase',
                    letterSpacing: '0.06em'
                  }}
                >
                  {h}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {rows.map((row, idx) => (
              <tr key={idx}>
                {headers.map((h) => (
                  <td
                    key={h}
                    style={{
                      borderBottom: '1px solid #222',
                      padding: '6px 8px',
                      fontSize: '0.9rem'
                    }}
                  >
                    {row[h]}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )
}

export default App
